<!-- Google Map Template -->
<template id="gm">
  <style>
    html{height:100%}
    body{height:100%;margin:0;padding:0}
    /* Map Style */
    .gm-template{float:left}
    .gmnoprint a img{display:none}
    .gm-template div[dir="ltr"]{visibility:hidden}
    .gmnoprint div a{display:none}
    .gmnoprint div span{display:none}
    .gmnoprint div a span:parent{display:none}
    .gmnoprint div a span{display:none}
    .gm-template a[title="Clique para ver esta área no Google Maps"] div{display:none}
    .gm-template a[title="Informar erros no mapa ou nas imagens para o Google"]{display:none}
    .gmnoscreen{display:none}
    /* Tooltip Style */
    .gs-address{text-decoration:none}
    .gm-style .gm-style-iw {font-weight:300;font-size:12px;overflow:hidden}
    .gm-style .gm-iw{color:#2c2c2c}
    .gm-style .gm-iw b{font-weight:400}
    .gm-style .gm-iw a:link,
    .gm-style .gm-iw a:visited{color:#4272db;text-decoration:none}
    .gm-style .gm-iw a:hover{color:#4272db;text-decoration:underline}
    .gm-style .gm-iw .gm-title{font-weight:400;margin-bottom:1px}
    .gm-style .gm-iw .gm-basicinfo{line-height:18px;padding-bottom:12px}
    .gm-style .gm-iw .gm-website{padding-top:6px}
    .gm-style .gm-iw .gm-photos{padding-bottom:8px;-ms-user-select:none;-moz-user-select:none;-webkit-user-select:none}
    .gm-style .gm-iw .gm-sv,
    .gm-style .gm-iw .gm-ph{cursor:pointer;height:50px;width:100px;position:relative;overflow:hidden}
    .gm-style .gm-iw .gm-sv{padding-right:4px}
    .gm-style .gm-iw .gm-wsv{cursor:pointer;position:relative;overflow:hidden}
    .gm-style .gm-iw .gm-sv-label,
    .gm-style .gm-iw .gm-ph-label{cursor:pointer;position:absolute;bottom:6px;color:#fff;font-weight:400;text-shadow:rgba(0,0,0,0.7) 0 1px 4px;font-size:12px}
    .gm-style .gm-iw .gm-stars-b,
    .gm-style .gm-iw .gm-stars-f{height:13px;font-size:0}
    .gm-style .gm-iw .gm-stars-b{position:relative;background-position:0 0;width:65px;top:3px;margin:0 5px}
    .gm-style .gm-iw .gm-rev{line-height:20px;-ms-user-select:none;-moz-user-select:none;-webkit-user-select:none}
    .gm-style.gm-china .gm-iw .gm-rev{display:none}
    .gm-style .gm-iw .gm-numeric-rev{font-size:16px;color:#dd4b39;font-weight:400}
    .gm-style .gm-iw.gm-transit{margin-left:15px}
    .gm-style .gm-iw.gm-transit td{vertical-align:top}
    .gm-style .gm-iw.gm-transit .gm-time{white-space:nowrap;color:#676767;font-weight:bold}
    .gm-style .gm-iw.gm-transit img{width:15px;height:15px;margin:1px 5px 0 -20px;float:left}
    .gm-iw {text-align:left}
    .gm-iw .gm-numeric-rev{float:left}
    .gm-iw .gm-photos,
    .gm-iw .gm-rev{direction:ltr;}
    .gm-iw .gm-stars-f,
    .gm-iw .gm-stars-b{background:url("https://maps.gstatic.com/mapfiles/api-3/images/review_stars.png") no-repeat;background-size:65px 26px;float:left}
    .gm-iw .gm-stars-f{background-position:left -13px}
    .gm-iw .gm-sv-label,
    .gm-iw .gm-ph-label{left:4px}
    .gs-result a,
    .gs-result span{text-decoration:none}
    .gs-result a:hover{text-decoration:underline}
    .gs-label, 
    .gs-title .gs-title-a{color:rgb(85,26,139);text-decoration:none}
    .gs-title .gs-title-a:hover{color:rgb(85,26,139);text-decoration:none;cursor:default}
    .gs-address span,
    .gs-directions-to-from span{display:inline;float:left;width:auto}
    .gs-directions-to-from .gs-label{clear:all}
  </style>
  <div class="gm-template"></div>
</template>
<!-- Google Map Tooltip Template -->
<template id="gm-tooltip">
  <div class="gmls-result-wrapper">
    <div class="gs-localResult gs-result">
      <div class="gs-title"><a class="gs-title-a" href="http://www.google.com/maps?source=uds&q=[route.long_name]%2C+[nr]+[bairro][locality.long_name]+-+[administrative_area_level_1.short_name]%2C [cep][country.long_name]" target="_blank">Endereço:&nbsp;</a></div>
      <div class="gs-address">
        <span class="gs-street gs-addressLine"> 
          <a href="http://maps.google.com/maps/place?q=[route.long_name]%2C+[nr]+[bairro][locality.long_name]+-+[administrative_area_level_1.short_name]%2C [cep][country.long_name]&amp;hl=pt-BR&amp;authuser=0&amp;cd=1&amp;cad=src:ppiwlink&amp;ei=3xfFT4K-MY-IzAWZkcXlDQ&amp;dtab=0" target="_blank">[raw_route.long_name], [raw_nr] [raw_bairro]</a>
        </span>
        <span class="gs-spacer">&nbsp;-&nbsp;</span>
        <span class="gs-city gs-addressLine">
          <a href="http://maps.google.com/maps/place?q=[route.long_name]%2C+[nr]+[bairro][locality.long_name]+-+[administrative_area_level_1.short_name]%2C [cep][country.long_name]&amp;hl=pt-BR&amp;authuser=0&amp;cd=1&amp;cad=src:ppiwlink&amp;ei=3xfFT4K-MY-IzAWZkcXlDQ&amp;dtab=0" target="_blank">[raw_locality.long_name]/[raw_administrative_area_level_1.short_name]</a>
        </span>
      </div>
      <div class="gs-directions-to-from">
        <span class="gs-label">Rota:&nbsp;</span>
        <span class="gs-secondary-link">
          <a class="gs-secondary-link-a" href="http://www.google.com/maps?source=uds&daddr=[route.long_name]%2C+[nr]+[bairro][locality.long_name]+-+[administrative_area_level_1.short_name]%2C [cep][country.long_name]+([route.long_name],+[nr])+@+[latitude],[longitude]&iwstate1=dir:to" target="_blank">Para cá</a>
        </span>
        <span class="gs-spacer">&nbsp;-&nbsp;</span>
        <span class="gs-secondary-link">
          <a class="gs-secondary-link-a" href="http://www.google.com/maps?source=uds&saddr=[route.long_name],+[nr]+[bairro][locality.long_name]+-+[administrative_area_level_1.short_name], [cep][country.long_name]+([route.long_name],+[nr])+@+[latitude],[longitude]&iwstate1=dir:from" target="_blank">Daqui</a>
        </span>
      </div>
    </div>
  </div>
</template>
<script>
  var App = App || {};
  App = {
    Def : {
      width : 400, //OK
      height : 400, //OK
      zoom : 16, //OK
      latitude : -5.195239528770433, //OK
      longitude : -37.341639999999984, //OK
      border : true, //OK
      tooltip: true,
      panControl: false,
      zoomControl: false,
      mapTypeControl: false,
      scaleControl: false,
      streetViewControl: false,
      overviewMapControl: false,
      disableDefaultUI: true
    },
    Ext : {
      URL : {
        Encode : function(str) {
          str = (str + '').toString();
          return encodeURIComponent(str).replace(/!/g, '%21').replace(/'/g, '%27').replace(/\(/g, '%28').replace(/\)/g, '%29').replace(/\*/g, '%2A').replace(/%20/g, '+');
        },
        Decode : function(str) {
          return decodeURIComponent(str).replace(/%21/g, '!').replace(/%27/g, "'").replace(/%28/g, '(').replace(/%29/g, ')').replace(/%2A/g, '*').replace(/[+]/g, '%20');
        }
      },
      String : {
        Replace : function(string, token, newtoken) {
          while (string.indexOf(token) != -1) {
            string = string.replace(token, newtoken);
          }
          return string;
        }
      },
      Map : {
        setMarkerInfoWin : function(place, latitude, longitude, template) {
          var html,
              place = place[0],
              nr = place['street_number'] ? place['street_number'].long_name + '' : '',
              bairro = place['sublocality'] ? place['sublocality'].long_name + '+,+' : '',
              cep = place['postal_code'] ? place['postal_code'].long_name + ',+' : '';

          template = template.innerHTML;
          template = App.Ext.String.Replace(template, '[raw_route.long_name]', place['route'].long_name);
          template = App.Ext.String.Replace(template, '[raw_nr]', nr);
          template = App.Ext.String.Replace(template, '[raw_bairro]', bairro);
          template = App.Ext.String.Replace(template, '[raw_locality.long_name]', place['locality'].long_name);
          template = App.Ext.String.Replace(template, '[raw_administrative_area_level_1.short_name]', place['administrative_area_level_1'].short_name);

          template = App.Ext.String.Replace(template, '[route.long_name]', App.Ext.URL.Encode(place['route'].long_name));
          template = App.Ext.String.Replace(template, '[nr]', App.Ext.URL.Encode(nr));
          template = App.Ext.String.Replace(template, '[locality.long_name]', App.Ext.URL.Encode(place['locality'].long_name));
          template = App.Ext.String.Replace(template, '[administrative_area_level_1.short_name]', App.Ext.URL.Encode(place['administrative_area_level_1'].short_name));
          template = App.Ext.String.Replace(template, '[cep]', App.Ext.URL.Encode(cep));
          template = App.Ext.String.Replace(template, '[bairro]', App.Ext.URL.Encode(bairro));
          template = App.Ext.String.Replace(template, '[country.long_name]', App.Ext.URL.Encode(place['country'].long_name));
          template = App.Ext.String.Replace(template, '[latitude]', latitude);
          template = App.Ext.String.Replace(template, '[longitude]', longitude);

          return template;
        },
        getAddress : function(place) {
          var place = place[0],
              nr = place['street_number'] ? place['street_number'].long_name + '' : '',
              bairro = place['sublocality'] ? place['sublocality'].long_name + ' , ' : '',
              cep = place['postal_code'] ? place['postal_code'].long_name + ', ' : '';
          return place['route'].long_name + ', ' + nr + bairro + ' - ' + place['locality'].long_name + '/' + place['administrative_area_level_1'].short_name;
        },
        getLocation : function(place) {
          var arrayAddress = [],
              mapAddress = [];
          for (var i = 0; i < place.length; i++) {
            var address = place[i];
            switch(address.types[0]) {
              case 'street_number' :
                arrayAddress['street_number'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
              case 'route' :
                arrayAddress['route'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
              case 'sublocality' :
                arrayAddress['sublocality'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
              case 'locality' :
                arrayAddress['locality'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
              case 'administrative_area_level_1' :
                arrayAddress['administrative_area_level_1'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
              case 'country' :
                arrayAddress['country'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
              case 'postal_code' :
                arrayAddress['postal_code'] = { short_name : address.short_name, long_name : address.long_name };
                mapAddress.push(arrayAddress);
              break;
            }
          }
          return mapAddress;
        },
        setLocation : function(self, location) {
          if(self.hasAttribute('return')) {
            var element = document.querySelectorAll(self.getAttribute('return'));
            if(element.length > 0) {
              document.querySelectorAll(self.getAttribute('return'))[0].setAttribute('value',location);
            }
            else {
              var newNode = document.createElement("input");
              newNode.setAttribute('type', 'text');
              newNode.setAttribute('id', self.getAttribute('return').replace('#',''));
              newNode.setAttribute('name', self.getAttribute('return').replace('#',''));
              newNode.setAttribute('value', location);
              self.parentNode.insertBefore(newNode, self.nextSibling);
            }
          }
        },
        setCoordinates : function(self) {
          if ((self.hasAttribute('latitude') && self.getAttribute('latitude') != '') && (self.hasAttribute('longitude') && self.getAttribute('longitude') != '')) {
            var latitude = self.getAttribute('latitude'),
                longitude = self.getAttribute('longitude');
          }
          else {
            var latitude = App.Def.latitude,
                longitude = App.Def.longitude;
                self.setAttribute('latitude',App.Def.latitude);
                self.setAttribute('longitude',App.Def.longitude);
          }
          return [latitude,longitude];
        },
        setAddress : function(self) {
          if (self.hasAttribute('address') && self.getAttribute('address') != '') {
            return self.getAttribute('address');
          }
          else {
            return mapByLatLong(self);
          }
        }
      }
    }
  };

  //Carrega de Modo Assincrono a Biblioteca do Google Maps V3
  window.onload = function() {
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false&callback=__autoload';
    //script.src = 'http://maps.googleapis.com/maps/api/js?v=3&sensor=false&callback=__autoload';
    document.body.appendChild(script);
  };

  var currentScript = document._currentScript || document.currentScript,
      doc = currentScript.ownerDocument;

  //Autoload da API do Google Maps v3
  var __autoload = function(){
      var proto = Object.create(HTMLElement.prototype, {
          createdCallback: {
              value: function() {
                  var template = doc.querySelector('#gm'),
                      clone = document.importNode(template.content, true),
                      tooltip = doc.querySelector('#gm-tooltip').content.querySelector('.gmls-result-wrapper');

                  this.shadowRoot = this.createShadowRoot();
                  this.shadowRoot.appendChild(clone);
                  this.element = this.shadowRoot.querySelector('.gm-template');

                  //Geolocalização por Latitude e Longitude
                  var mapByLatLong = function(self) {
                      var latitude = App.Ext.Map.setCoordinates(self)[0];
                      var longitude = App.Ext.Map.setCoordinates(self)[1];
                      var coords = new google.maps.LatLng(latitude, longitude);
                      var map = new google.maps.Map(self.element, {
                          zoom : self.hasAttribute('zoom') && self.getAttribute('zoom') != '' ? parseInt(self.getAttribute('zoom')) : App.Def.zoom,
                          mapTypeId : google.maps.MapTypeId.ROADMAP,
                          center : coords,
                          panControl : App.Def.panControl,
                          streetViewControl : App.Def.streetViewControl,
                          mapTypeControl : App.Def.mapTypeControl,
                          disableDefaultUI: App.Def.disableDefaultUI
                      });
                      var geocoder = new google.maps.Geocoder();
                      geocoder.geocode( { "latLng" : coords }, function(results, status) {
                          if (status == google.maps.GeocoderStatus.OK) {
                              mapAddress = App.Ext.Map.getLocation(results[0].address_components);
                              map.setCenter(coords);
                              map.setZoom(self.hasAttribute('zoom') && self.getAttribute('zoom') != '' ? parseInt(self.getAttribute('zoom')) : App.Def.zoom);
                              marker = new google.maps.Marker({
                                  position : coords,
                                  animation : google.maps.Animation.DROP,
                                  map : map
                              });
                              var infoWin = new google.maps.InfoWindow({
                                  content : App.Ext.Map.setMarkerInfoWin(mapAddress, latitude, longitude, tooltip)
                              });
                              infoWin.open(map, marker);
                              self.setAttribute('address', App.Ext.Map.getAddress(mapAddress));
                              App.Ext.Map.setLocation(self, App.Ext.Map.getAddress(mapAddress));
                          }
                      });
                  };

                  //Geolocalização Reversa
                  var mapByAddress = function(self) {
                      var address = App.Ext.Map.setAddress(self);
                      var map = new google.maps.Map(self.element, {
                          zoom : self.hasAttribute('zoom') && self.getAttribute('zoom') != '' ? parseInt(self.getAttribute('zoom')) : App.Def.zoom,
                          mapTypeId : google.maps.MapTypeId.ROADMAP,
                          center : new google.maps.LatLng(0,0),
                          panControl : App.Def.panControl,
                          streetViewControl : App.Def.streetViewControl,
                          mapTypeControl : App.Def.mapTypeControl,
                          disableDefaultUI: App.Def.disableDefaultUI
                      });
                      var geocoder = new google.maps.Geocoder(); 
                      geocoder.geocode({
                              address : address,
                              region : 'no' 
                          },
                          function(results, status) {
                              if (status == google.maps.GeocoderStatus.OK) {
                                  mapAddress = App.Ext.Map.getLocation(results[0].address_components);
                                  var coords = new google.maps.LatLng(results[0]['geometry']['location'].lat(), results[0]['geometry']['location'].lng());
                                  map.setCenter(coords);
                                  map.setZoom(self.hasAttribute('zoom') && self.getAttribute('zoom') != '' ? parseInt(self.getAttribute('zoom')) : App.Def.zoom);
                                  marker = new google.maps.Marker({
                                      position : coords, 
                                      animation : google.maps.Animation.DROP,
                                      map : map
                                  });
                                  var infoWin = new google.maps.InfoWindow({
                                      content : App.Ext.Map.setMarkerInfoWin(mapAddress, coords.lat(), coords.lng(), tooltip)
                                  });
                                  infoWin.open(map, marker);
                                  self.setAttribute('latitude', coords.lat());
                                  self.setAttribute('longitude', coords.lng());
                                  App.Ext.Map.setLocation(self, coords.lat() + ',' + coords.lng());
                              }
                          }
                      );
                  };

                  //Trata a Largura
                  if (this.hasAttribute('width') && this.getAttribute('width') != '') {
                      this.style.width = this.getAttribute('width') + 'px';
                      this.element.style.width = this.getAttribute('width') + 'px';
                  }
                  else {
                      this.style.width = App.Def.width + 'px';
                      this.element.style.width = App.Def.width + 'px';
                      this.setAttribute('width',App.Def.width);
                  }
                  //Trata a Altura
                  if (this.hasAttribute('height') && this.getAttribute('height') != '') {
                      this.style.height = this.getAttribute('height') + 'px';
                      this.element.style.height = this.getAttribute('height') + 'px';
                  }
                  else {
                      this.style.height = App.Def.height + 'px';
                      this.element.style.height = App.Def.height + 'px';
                      this.setAttribute('height',App.Def.height);
                  }
                  //Trata a Borda
                  if (this.hasAttribute('border') && this.getAttribute('border') == 'false') {
                      this.element.style.border = 'none';
                  }
                  else {
                      this.element.style.border = 'solid 1px #000';
                  }

                  //Alterna entre Busca por Endereço ou por Latitude/Longitude
                  if (this.hasAttribute('address') && this.getAttribute('address') != '') {
                      mapByAddress(this);
                  }
                  else {
                      mapByLatLong(this);
                  }
              }
          }
      });
      //Finalmente Registra o Elemento
      document.registerElement('google-map', {prototype: proto});
  }
</script>