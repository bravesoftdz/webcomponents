<script>
  // Simula a Função Date do PHP [http://jacwright.com/projects/javascript/date_format/]
  Date.prototype.format=function(e){var t="";var n=Date.replaceChars;for(var r=0;r<e.length;r++){var i=e.charAt(r);if(r-1>=0&&e.charAt(r-1)=="\\"){t+=i}else if(n[i]){t+=n[i].call(this)}else if(i!="\\"){t+=i}}return t};Date.replaceChars={shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longMonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longDays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d:function(){return(this.getDate()<10?"0":"")+this.getDate()},D:function(){return Date.replaceChars.shortDays[this.getDay()]},j:function(){return this.getDate()},l:function(){return Date.replaceChars.longDays[this.getDay()]},N:function(){return this.getDay()+1},S:function(){return this.getDate()%10==1&&this.getDate()!=11?"st":this.getDate()%10==2&&this.getDate()!=12?"nd":this.getDate()%10==3&&this.getDate()!=13?"rd":"th"},w:function(){return this.getDay()},z:function(){var e=new Date(this.getFullYear(),0,1);return Math.ceil((this-e)/864e5)},W:function(){var e=new Date(this.getFullYear(),0,1);return Math.ceil(((this-e)/864e5+e.getDay()+1)/7)},F:function(){return Date.replaceChars.longMonths[this.getMonth()]},m:function(){return(this.getMonth()<9?"0":"")+(this.getMonth()+1)},M:function(){return Date.replaceChars.shortMonths[this.getMonth()]},n:function(){return this.getMonth()+1},t:function(){var e=new Date;return(new Date(e.getFullYear(),e.getMonth(),0)).getDate()},L:function(){var e=this.getFullYear();return e%400==0||e%100!=0&&e%4==0},o:function(){var e=new Date(this.valueOf());e.setDate(e.getDate()-(this.getDay()+6)%7+3);return e.getFullYear()},Y:function(){return this.getFullYear()},y:function(){return(""+this.getFullYear()).substr(2)},a:function(){return this.getHours()<12?"am":"pm"},A:function(){return this.getHours()<12?"AM":"PM"},B:function(){return Math.floor(((this.getUTCHours()+1)%24+this.getUTCMinutes()/60+this.getUTCSeconds()/3600)*1e3/24)},g:function(){return this.getHours()%12||12},G:function(){return this.getHours()},h:function(){return((this.getHours()%12||12)<10?"0":"")+(this.getHours()%12||12)},H:function(){return(this.getHours()<10?"0":"")+this.getHours()},i:function(){return(this.getMinutes()<10?"0":"")+this.getMinutes()},s:function(){return(this.getSeconds()<10?"0":"")+this.getSeconds()},u:function(){var e=this.getMilliseconds();return(e<10?"00":e<100?"0":"")+e},e:function(){return"Not Yet Supported"},I:function(){var e=null;for(var t=0;t<12;++t){var n=new Date(this.getFullYear(),t,1);var r=n.getTimezoneOffset();if(e===null)e=r;else if(r<e){e=r;break}else if(r>e)break}return this.getTimezoneOffset()==e|0},O:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+"00"},P:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+":00"},T:function(){var e=this.getMonth();this.setMonth(0);var t=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,"$1");this.setMonth(e);return t},Z:function(){return-this.getTimezoneOffset()*60},c:function(){return this.format("Y-m-d\\TH:i:sP")},r:function(){return this.toString()},U:function(){return this.getTime()/1e3}};
  // Converte HTML String para DOM-Fragment
  String.prototype.toDOM=function(){var d=document,i,a=d.createElement("div"),b=d.createDocumentFragment();a.innerHTML=this;while(i=a.firstChild)b.appendChild(i);return b;};
  // Protótipo para ReplaceAll com Split e Join
  String.prototype.replaceAll = function(search, replacement) {
      var target = this;
      return target.split(search).join(replacement);
  };
</script>
<template id="feed">
    <style>
        :host{display:block}
        :host(.different){}
    </style>
    <div class="feed_template">
        <div class="feed_widget" data-order={{feed.order}}>
            <div class="feed_title dropdown dropdown-wide">
              <button>
                {{feed.title}}
                <span class="arrow-down"></span>
              </button>
              <ul class="dropdown-menu">{{feed.list}}</ul>
            </div>
            <div class="line"></div>
            <ul class="entries">{{feed.entries}}</ul>
            <small>Última Atualização: {{feed.updated}}</small>
        </div>
    </div>
</template>
<template id="entries">
    <li>
        <a href="{{link}}" target="_blank" class="entry_title">{{title}}</a>
        <small class="entry_published">{{publishedDate}}</small>
        <p>{{contentSnippet}}</p>
    </li>
</template>
<template id="list">
    <li>
        <a href="javascript:void(0)">{{feed.title}}</a>
    </li>
</template>
<script>
  var App = App || {};
  App = {
    Def : {
      url: 'http://feeds.bbci.co.uk/news/england/rss.xml',
      entries : 10,
      refresh : 10000
    },
    Ext : {
      MicroTemplate : function(temp, data) {
       data = [].concat(data);
       for (var i in data)
         for (var f in data[i])
           temp = temp.replace(new RegExp('{{' + f + '}}', 'ig'), data[i][f]);
       return temp;
      },
      MakeRequest : function(url, entry) {
        var template = 'http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num={{entries}}&q={{url}}&callback=__autoload';
        var data = { url : url, entries : entry }
        return App.Ext.MicroTemplate(template, data);
      },
      FetchFeed : function(url) {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = url;
        document.getElementsByTagName("head")[0].appendChild(script);
        //document.body.appendChild(script);
      },
      FetchStyle : function(url, root) {
        var style = document.createElement('style');
        style.setAttribute("type", "text/css");
        var textNode = document.createTextNode("@import '" + url + "';");
        style.appendChild(textNode);
        root.appendChild(style);
      }
    }
  };

  var currentScript = document._currentScript || document.currentScript,
      doc = currentScript.ownerDocument;

  var proto = Object.create(HTMLElement.prototype, {
      createdCallback: {
          value: function() {
              var template = doc.querySelector('#feed'),
                  clone = document.importNode(template.content, true),
                  content = template.content.querySelector('.feed_template').innerHTML,
                  entries = doc.querySelector('#entries').content.querySelector('li'),
                  list = doc.querySelector('#list').content.querySelector('li');

              this.shadowRoot = this.createShadowRoot();
              this.shadowRoot.appendChild(clone);
              this.element = this.shadowRoot.querySelector('.feed_template');
              this.entries = entries.outerHTML;
              this.list = list.outerHTML;
  
              //Atributos Pseudo-Opcionais
              var url = this.hasAttribute('url') && this.getAttribute('url') != '' ? this.getAttribute('url') : App.Def.url
                  entry = this.hasAttribute('entries') && this.getAttribute('entries') != '' ? this.getAttribute('entries') : App.Def.entries;

              //Salva o Objeto e o Feed uma Variável
              var self = this,
                  feed = [],
                  menu = [],
                  index = [],
                  root = this.shadowRoot;

              window.onload = function() {

                  //var parser = new DOMParser();
                  //var doc = parser.parseFromString('<!DOCTYPE html><html><head></head><body>' + self.element.outerHTML + '</body></html>', "text/html");
                  //console.log(doc.querySelector(".dropdown-menu"));

                  //Limpa o Modelo
                  self.element.innerHTML = '';
                  var urls = url.split(',').reverse();
                  if(urls.length == 1) {
                      index.push(0);
                      App.Ext.FetchFeed(App.Ext.MakeRequest(urls.toString(), entry));
                  }
                  else {
                      for (var key in urls) {
                          index.push(parseInt(key));
                          App.Ext.FetchFeed(App.Ext.MakeRequest(urls[key], entry));
                      }
                  }
                  App.Ext.FetchStyle(self.getAttribute('css'), root);
              };

              __autoload = function(data){
                  var result = data.responseData.feed,
                      status = data.responseStatus,
                      list = '',
                      items = '';

                      //Monta o DropDown
                      menu.push(result.title);
                      list += App.Ext.MicroTemplate(self.list, { 'feed.title' : menu[0] });

                      //Reordena os Feeds de Acordo com Ordem de Execução
                      index.reverse();
                      result.order = index[0];
                      index.shift();

                  //Itera os Itens
                  for (var key in result.entries) {
                      //Formata a Data
                      result.entries[key].publishedDate = new Date(result.entries[key].publishedDate).format('d/m/Y \\à\\s h:i:s');
                      items += App.Ext.MicroTemplate(self.entries, result.entries[key]);
                  }

                  //Modelo de Objetos do Feed
                  var model = {
                      'feed.author' : result.author,
                      'feed.title' : result.title,
                      'feed.description' : result.description,
                      'feed.link' : result.link,
                      'feed.type' : result.type,
                      'feed.updated' : new Date().format('d/m/Y \\à\\s h:i:s'),
                      'feed.order' : result.order,
                      'feed.entries' : items
                  };

                  var dropdown = {
                      'feed.list' : list
                  }

                  //Aplica o Conteúdo no Modelo
                  conteudo = App.Ext.MicroTemplate(App.Ext.MicroTemplate(content, dropdown), model).replaceAll(' ...', '...');

                  var parser = new DOMParser();
                  var dom = parser.parseFromString('<!DOCTYPE html><html><head></head><body>' + conteudo + '</body></html>', "text/html");
                  if(dom.querySelector(".feed_widget[data-order='0']") !== null) {
                      dom.querySelector(".feed_widget[data-order='0']").style.display = 'block';
                  }
                  if(dom.querySelector(".feed_widget:not([data-order='0'])") !== null) {
                      dom.querySelector(".feed_widget:not([data-order='0'])").style.display = 'none';
                  }

                  feed.push(dom.body.innerHTML);
                  //feed.push(conteudo);
                  self.element.innerHTML = feed.join('');
              };
          }
      }
  });
  //Finalmente Registra o Elemento
  document.registerElement('google-feed', {prototype: proto});
</script>